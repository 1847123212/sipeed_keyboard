name: Keyboard Firmware CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Cache toolchain
      id: cache
      uses: actions/cache@v1
      with: 
        path: riscv64-elf-x86_64-20210120.tar.gz
        key : ${{runner.OS}}-riscv64-elf-x86_64-caches-${{ hashFiles('riscv64-elf-x86_64-20210120.tar.gz') }}

    - name: Download toolchain
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        wget -c https://dev.bouffalolab.com/media/upload/download/riscv64-elf-x86_64-20210120.tar.gz

    - name: Extra toolchain
      run: |
          mkdir /opt/riscv64-unknown-elf
          tar -zxvf riscv64-elf-x86_64-20210120.tar.gz -C /opt/riscv64-unknown-elf
    - name: make firmware
      env:
        PATH: /bin:/usr/bin:/opt/riscv64-unknown-elf/bin
      run: |
          cd firmware/bl_mcu_sdk 
          make build SUPPORT_FREERTOS=y BOARD=sipeed_keyboard APP=sipeed_keyboard_68
#     - name: make check
#       run: make check
#     - name: make distcheck
#       run: make distcheck
